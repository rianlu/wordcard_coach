# Flutter单词学习App - 数据库设计文档

## 一、本地数据库（SQLite / Drift）

### 1. 单词表 (words)

```sql
CREATE TABLE words (
    id TEXT PRIMARY KEY NOT NULL,           -- word_001, word_002...
    text TEXT NOT NULL,                     -- apple
    meaning TEXT NOT NULL,                  -- 苹果
    phonetic TEXT NOT NULL,                 -- /ˈæpl/
    grade INTEGER NOT NULL,                 -- 3, 4, 5, 6, 7, 8, 9
    semester INTEGER NOT NULL,              -- 1=上学期, 2=下学期
    unit TEXT NOT NULL,                     -- Unit 1, Unit 2...
    difficulty INTEGER NOT NULL,            -- 1-5 难度等级
    category TEXT NOT NULL                  -- food, animal, action, daily...
);

-- 索引
CREATE INDEX idx_words_grade_semester ON words(grade, semester);
CREATE INDEX idx_words_unit ON words(unit);
CREATE INDEX idx_words_category ON words(category);
CREATE INDEX idx_words_text ON words(text);
```

---

### 2. 例句表 (sentences)

```sql
CREATE TABLE sentences (
    id TEXT PRIMARY KEY NOT NULL,           -- sentence_001, sentence_002...
    text TEXT NOT NULL,                     -- I eat an apple for breakfast.
    translation TEXT NOT NULL,              -- 我早上吃苹果当早餐。
    category TEXT NOT NULL,                 -- breakfast, school, play...
    difficulty INTEGER NOT NULL             -- 1-5 难度等级
);

-- 索引
CREATE INDEX idx_sentences_category ON sentences(category);
```

---

### 3. 单词例句关联表 (word_sentence_map)

```sql
CREATE TABLE word_sentence_map (
    word_id TEXT NOT NULL,                  -- word_001
    sentence_id TEXT NOT NULL,              -- sentence_001
    is_primary INTEGER NOT NULL DEFAULT 1,  -- 是否是主例句 (1=是, 0=否)
    word_position INTEGER NOT NULL,         -- 单词在例句中的起始位置（用于高亮）
    
    PRIMARY KEY (word_id, sentence_id),
    FOREIGN KEY (word_id) REFERENCES words(id) ON DELETE CASCADE,
    FOREIGN KEY (sentence_id) REFERENCES sentences(id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_wsm_word ON word_sentence_map(word_id);
CREATE INDEX idx_wsm_sentence ON word_sentence_map(sentence_id);
CREATE INDEX idx_wsm_primary ON word_sentence_map(word_id, is_primary);
```

---

### 4. 学习进度表 (word_progress)

```sql
CREATE TABLE word_progress (
    id TEXT PRIMARY KEY NOT NULL,           -- UUID
    word_id TEXT NOT NULL,                  -- word_001
    
    -- SM-2 算法相关字段
    easiness_factor REAL NOT NULL DEFAULT 2.5,     -- 难度因子，初始2.5
    interval INTEGER NOT NULL DEFAULT 1,           -- 复习间隔（天）
    repetition INTEGER NOT NULL DEFAULT 0,         -- 连续正确次数
    next_review_date INTEGER NOT NULL DEFAULT 0,   -- 下次复习时间（时间戳毫秒）
    last_review_date INTEGER NOT NULL DEFAULT 0,   -- 上次复习时间（时间戳毫秒）
    
    -- 统计数据
    review_count INTEGER NOT NULL DEFAULT 0,       -- 复习总次数
    correct_count INTEGER NOT NULL DEFAULT 0,      -- 正确次数
    wrong_count INTEGER NOT NULL DEFAULT 0,        -- 错误次数
    mastery_level INTEGER NOT NULL DEFAULT 0,      -- 掌握度 0-100
    
    -- 学习模式统计
    select_mode_count INTEGER NOT NULL DEFAULT 0,  -- 选词模式练习次数
    spell_mode_count INTEGER NOT NULL DEFAULT 0,   -- 拼写模式练习次数
    speak_mode_count INTEGER NOT NULL DEFAULT 0,   -- 口语模式练习次数
    
    -- 时间戳
    created_at INTEGER NOT NULL,                   -- 创建时间（时间戳毫秒）
    updated_at INTEGER NOT NULL,                   -- 更新时间（时间戳毫秒）
    
    FOREIGN KEY (word_id) REFERENCES words(id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_progress_word ON word_progress(word_id);
CREATE INDEX idx_progress_review_date ON word_progress(next_review_date);
CREATE INDEX idx_progress_mastery ON word_progress(mastery_level);
```

---

### 5. 用户统计表 (user_stats)

```sql
CREATE TABLE user_stats (
    id INTEGER PRIMARY KEY NOT NULL DEFAULT 1,  -- 单例，只有一条记录
    
    -- 基本信息
    nickname TEXT NOT NULL DEFAULT '学习者',
    current_grade INTEGER NOT NULL DEFAULT 3,        -- 当前年级
    current_semester INTEGER NOT NULL DEFAULT 1,     -- 当前学期
    
    -- 学习统计
    total_words_learned INTEGER NOT NULL DEFAULT 0,  -- 已学单词总数
    total_words_mastered INTEGER NOT NULL DEFAULT 0, -- 已掌握单词数（掌握度>80）
    total_reviews INTEGER NOT NULL DEFAULT 0,        -- 复习总次数
    total_correct INTEGER NOT NULL DEFAULT 0,        -- 总正确次数
    total_wrong INTEGER NOT NULL DEFAULT 0,          -- 总错误次数
    
    -- 打卡统计
    continuous_days INTEGER NOT NULL DEFAULT 0,      -- 连续打卡天数
    total_study_days INTEGER NOT NULL DEFAULT 0,     -- 累计学习天数
    last_study_date TEXT NOT NULL DEFAULT '',        -- 上次学习日期 yyyy-MM-dd
    
    -- 学习时长（分钟）
    total_study_minutes INTEGER NOT NULL DEFAULT 0,
    
    -- 更新时间
    updated_at INTEGER NOT NULL                      -- 更新时间（时间戳毫秒）
);
```

---

### 6. 每日学习记录表 (daily_records)

```sql
CREATE TABLE daily_records (
    date TEXT PRIMARY KEY NOT NULL,              -- yyyy-MM-dd
    
    new_words_count INTEGER NOT NULL DEFAULT 0,  -- 今日新学单词数
    review_words_count INTEGER NOT NULL DEFAULT 0, -- 今日复习单词数
    correct_count INTEGER NOT NULL DEFAULT 0,    -- 今日正确次数
    wrong_count INTEGER NOT NULL DEFAULT 0,      -- 今日错误次数
    study_minutes INTEGER NOT NULL DEFAULT 0,    -- 今日学习时长（分钟）
    
    created_at INTEGER NOT NULL                  -- 创建时间（时间戳毫秒）
);

-- 索引
CREATE INDEX idx_daily_records_date ON daily_records(date);
```

---

## 二、Supabase数据库（PostgreSQL）

### 1. 用户表 (users)

```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    device_id TEXT UNIQUE NOT NULL,                  -- 设备唯一ID
    nickname TEXT DEFAULT '学习者',
    current_grade INTEGER DEFAULT 3,
    current_semester INTEGER DEFAULT 1,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_users_device_id ON users(device_id);
```

---

### 2. 学习进度表 (word_progress)

```sql
CREATE TABLE word_progress (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    word_id TEXT NOT NULL,                           -- 对应本地Word.id
    
    -- SM-2算法字段
    easiness_factor REAL DEFAULT 2.5,
    interval INTEGER DEFAULT 1,
    repetition INTEGER DEFAULT 0,
    next_review_date TIMESTAMP WITH TIME ZONE,
    last_review_date TIMESTAMP WITH TIME ZONE,
    
    -- 统计字段
    review_count INTEGER DEFAULT 0,
    correct_count INTEGER DEFAULT 0,
    wrong_count INTEGER DEFAULT 0,
    mastery_level INTEGER DEFAULT 0,
    
    select_mode_count INTEGER DEFAULT 0,
    spell_mode_count INTEGER DEFAULT 0,
    speak_mode_count INTEGER DEFAULT 0,
    
    -- 时间戳
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    -- 唯一约束：每个用户的每个单词只有一条记录
    UNIQUE(user_id, word_id)
);

-- 索引
CREATE INDEX idx_word_progress_user ON word_progress(user_id);
CREATE INDEX idx_word_progress_word ON word_progress(word_id);
CREATE INDEX idx_word_progress_review ON word_progress(user_id, next_review_date);
```

---

### 3. 用户统计表 (user_stats)

```sql
CREATE TABLE user_stats (
    user_id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
    
    -- 学习统计
    total_words_learned INTEGER DEFAULT 0,
    total_words_mastered INTEGER DEFAULT 0,
    total_reviews INTEGER DEFAULT 0,
    total_correct INTEGER DEFAULT 0,
    total_wrong INTEGER DEFAULT 0,
    
    -- 打卡统计
    continuous_days INTEGER DEFAULT 0,
    total_study_days INTEGER DEFAULT 0,
    last_study_date DATE,
    
    -- 学习时长
    total_study_minutes INTEGER DEFAULT 0,
    
    -- 时间戳
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

---

### 4. 每日记录表 (daily_records)

```sql
CREATE TABLE daily_records (
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    date DATE NOT NULL,
    
    new_words_count INTEGER DEFAULT 0,
    review_words_count INTEGER DEFAULT 0,
    correct_count INTEGER DEFAULT 0,
    wrong_count INTEGER DEFAULT 0,
    study_minutes INTEGER DEFAULT 0,
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    PRIMARY KEY (user_id, date)
);

-- 索引
CREATE INDEX idx_daily_records_user_date ON daily_records(user_id, date);
```

---

### 5. 学习日志表 (study_logs) - 可选

```sql
CREATE TABLE study_logs (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    word_id TEXT NOT NULL,
    
    activity_type TEXT NOT NULL,                     -- 'learn', 'review'
    mode TEXT,                                       -- 'select', 'spell', 'speak'
    is_correct BOOLEAN,
    duration_seconds INTEGER,                        -- 本次学习耗时
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_study_logs_user ON study_logs(user_id);
CREATE INDEX idx_study_logs_date ON study_logs(created_at);
```

---

## 三、预置数据JSON格式

### words.json

```json
[
  {
    "id": "word_001",
    "text": "apple",
    "meaning": "苹果",
    "phonetic": "/ˈæpl/",
    "grade": 3,
    "semester": 1,
    "unit": "Unit 1",
    "difficulty": 1,
    "category": "food"
  },
  {
    "id": "word_002",
    "text": "banana",
    "meaning": "香蕉",
    "phonetic": "/bəˈnænə/",
    "grade": 3,
    "semester": 1,
    "unit": "Unit 1",
    "difficulty": 1,
    "category": "food"
  },
  {
    "id": "word_003",
    "text": "cat",
    "meaning": "猫",
    "phonetic": "/kæt/",
    "grade": 3,
    "semester": 1,
    "unit": "Unit 1",
    "difficulty": 1,
    "category": "animal"
  }
]
```

---

### sentences.json

```json
[
  {
    "id": "sentence_001",
    "text": "I eat an apple for breakfast.",
    "translation": "我早上吃苹果当早餐。",
    "category": "breakfast",
    "difficulty": 1
  },
  {
    "id": "sentence_002",
    "text": "She likes bananas and oranges.",
    "translation": "她喜欢香蕉和橙子。",
    "category": "food",
    "difficulty": 1
  },
  {
    "id": "sentence_003",
    "text": "The cat is very cute.",
    "translation": "这只猫非常可爱。",
    "category": "daily",
    "difficulty": 1
  }
]
```

---

### word_sentence_map.json

```json
[
  {
    "wordId": "word_001",
    "sentenceId": "sentence_001",
    "isPrimary": true,
    "wordPosition": 10
  },
  {
    "wordId": "word_002",
    "sentenceId": "sentence_002",
    "isPrimary": true,
    "wordPosition": 11
  },
  {
    "wordId": "word_003",
    "sentenceId": "sentence_003",
    "isPrimary": true,
    "wordPosition": 4
  }
]
```

---

## 四、Flutter数据库实现建议

### 推荐使用的包

```yaml
dependencies:
  # SQLite数据库
  sqflite: ^2.3.0
  path: ^1.8.3
  
  # 或者使用Drift（类型安全的SQLite ORM）
  drift: ^2.14.0
  
  # Supabase
  supabase_flutter: ^2.0.0
  
  # JSON解析
  json_annotation: ^4.8.1
  
dev_dependencies:
  # Drift代码生成
  drift_dev: ^2.14.0
  build_runner: ^2.4.7
  
  # JSON序列化代码生成
  json_serializable: ^6.7.1
```

---

### 数据模型示例（Dart）

```dart
// ============================================
// Word 模型
// ============================================
class Word {
  final String id;
  final String text;
  final String meaning;
  final String phonetic;
  final int grade;
  final int semester;
  final String unit;
  final int difficulty;
  final String category;

  Word({
    required this.id,
    required this.text,
    required this.meaning,
    required this.phonetic,
    required this.grade,
    required this.semester,
    required this.unit,
    required this.difficulty,
    required this.category,
  });

  factory Word.fromJson(Map<String, dynamic> json) => Word(
        id: json['id'] as String,
        text: json['text'] as String,
        meaning: json['meaning'] as String,
        phonetic: json['phonetic'] as String,
        grade: json['grade'] as int,
        semester: json['semester'] as int,
        unit: json['unit'] as String,
        difficulty: json['difficulty'] as int,
        category: json['category'] as String,
      );

  Map<String, dynamic> toJson() => {
        'id': id,
        'text': text,
        'meaning': meaning,
        'phonetic': phonetic,
        'grade': grade,
        'semester': semester,
        'unit': unit,
        'difficulty': difficulty,
        'category': category,
      };
}

// ============================================
// Sentence 模型
// ============================================
class Sentence {
  final String id;
  final String text;
  final String translation;
  final String category;
  final int difficulty;

  Sentence({
    required this.id,
    required this.text,
    required this.translation,
    required this.category,
    required this.difficulty,
  });

  factory Sentence.fromJson(Map<String, dynamic> json) => Sentence(
        id: json['id'] as String,
        text: json['text'] as String,
        translation: json['translation'] as String,
        category: json['category'] as String,
        difficulty: json['difficulty'] as int,
      );

  Map<String, dynamic> toJson() => {
        'id': id,
        'text': text,
        'translation': translation,
        'category': category,
        'difficulty': difficulty,
      };
}

// ============================================
// WordSentenceMap 模型
// ============================================
class WordSentenceMap {
  final String wordId;
  final String sentenceId;
  final bool isPrimary;
  final int wordPosition;

  WordSentenceMap({
    required this.wordId,
    required this.sentenceId,
    required this.isPrimary,
    required this.wordPosition,
  });

  factory WordSentenceMap.fromJson(Map<String, dynamic> json) =>
      WordSentenceMap(
        wordId: json['wordId'] as String,
        sentenceId: json['sentenceId'] as String,
        isPrimary: json['isPrimary'] as bool,
        wordPosition: json['wordPosition'] as int,
      );

  Map<String, dynamic> toJson() => {
        'wordId': wordId,
        'sentenceId': sentenceId,
        'isPrimary': isPrimary ? 1 : 0,
        'wordPosition': wordPosition,
      };
}

// ============================================
// WordProgress 模型
// ============================================
class WordProgress {
  final String id;
  final String wordId;
  final double easinessFactor;
  final int interval;
  final int repetition;
  final int nextReviewDate;
  final int lastReviewDate;
  final int reviewCount;
  final int correctCount;
  final int wrongCount;
  final int masteryLevel;
  final int selectModeCount;
  final int spellModeCount;
  final int speakModeCount;
  final int createdAt;
  final int updatedAt;

  WordProgress({
    required this.id,
    required this.wordId,
    this.easinessFactor = 2.5,
    this.interval = 1,
    this.repetition = 0,
    this.nextReviewDate = 0,
    this.lastReviewDate = 0,
    this.reviewCount = 0,
    this.correctCount = 0,
    this.wrongCount = 0,
    this.masteryLevel = 0,
    this.selectModeCount = 0,
    this.spellModeCount = 0,
    this.speakModeCount = 0,
    required this.createdAt,
    required this.updatedAt,
  });

  factory WordProgress.fromJson(Map<String, dynamic> json) => WordProgress(
        id: json['id'] as String,
        wordId: json['word_id'] as String,
        easinessFactor: (json['easiness_factor'] as num).toDouble(),
        interval: json['interval'] as int,
        repetition: json['repetition'] as int,
        nextReviewDate: json['next_review_date'] as int,
        lastReviewDate: json['last_review_date'] as int,
        reviewCount: json['review_count'] as int,
        correctCount: json['correct_count'] as int,
        wrongCount: json['wrong_count'] as int,
        masteryLevel: json['mastery_level'] as int,
        selectModeCount: json['select_mode_count'] as int,
        spellModeCount: json['spell_mode_count'] as int,
        speakModeCount: json['speak_mode_count'] as int,
        createdAt: json['created_at'] as int,
        updatedAt: json['updated_at'] as int,
      );

  Map<String, dynamic> toJson() => {
        'id': id,
        'word_id': wordId,
        'easiness_factor': easinessFactor,
        'interval': interval,
        'repetition': repetition,
        'next_review_date': nextReviewDate,
        'last_review_date': lastReviewDate,
        'review_count': reviewCount,
        'correct_count': correctCount,
        'wrong_count': wrongCount,
        'mastery_level': masteryLevel,
        'select_mode_count': selectModeCount,
        'spell_mode_count': spellModeCount,
        'speak_mode_count': speakModeCount,
        'created_at': createdAt,
        'updated_at': updatedAt,
      };
}

// ============================================
// UserStats 模型
// ============================================
class UserStats {
  final int id;
  final String nickname;
  final int currentGrade;
  final int currentSemester;
  final int totalWordsLearned;
  final int totalWordsMastered;
  final int totalReviews;
  final int totalCorrect;
  final int totalWrong;
  final int continuousDays;
  final int totalStudyDays;
  final String lastStudyDate;
  final int totalStudyMinutes;
  final int updatedAt;

  UserStats({
    this.id = 1,
    this.nickname = '学习者',
    this.currentGrade = 3,
    this.currentSemester = 1,
    this.totalWordsLearned = 0,
    this.totalWordsMastered = 0,
    this.totalReviews = 0,
    this.totalCorrect = 0,
    this.totalWrong = 0,
    this.continuousDays = 0,
    this.totalStudyDays = 0,
    this.lastStudyDate = '',
    this.totalStudyMinutes = 0,
    required this.updatedAt,
  });

  factory UserStats.fromJson(Map<String, dynamic> json) => UserStats(
        id: json['id'] as int,
        nickname: json['nickname'] as String,
        currentGrade: json['current_grade'] as int,
        currentSemester: json['current_semester'] as int,
        totalWordsLearned: json['total_words_learned'] as int,
        totalWordsMastered: json['total_words_mastered'] as int,
        totalReviews: json['total_reviews'] as int,
        totalCorrect: json['total_correct'] as int,
        totalWrong: json['total_wrong'] as int,
        continuousDays: json['continuous_days'] as int,
        totalStudyDays: json['total_study_days'] as int,
        lastStudyDate: json['last_study_date'] as String,
        totalStudyMinutes: json['total_study_minutes'] as int,
        updatedAt: json['updated_at'] as int,
      );

  Map<String, dynamic> toJson() => {
        'id': id,
        'nickname': nickname,
        'current_grade': currentGrade,
        'current_semester': currentSemester,
        'total_words_learned': totalWordsLearned,
        'total_words_mastered': totalWordsMastered,
        'total_reviews': totalReviews,
        'total_correct': totalCorrect,
        'total_wrong': totalWrong,
        'continuous_days': continuousDays,
        'total_study_days': totalStudyDays,
        'last_study_date': lastStudyDate,
        'total_study_minutes': totalStudyMinutes,
        'updated_at': updatedAt,
      };
}

// ============================================
// DailyRecord 模型
// ============================================
class DailyRecord {
  final String date;
  final int newWordsCount;
  final int reviewWordsCount;
  final int correctCount;
  final int wrongCount;
  final int studyMinutes;
  final int createdAt;

  DailyRecord({
    required this.date,
    this.newWordsCount = 0,
    this.reviewWordsCount = 0,
    this.correctCount = 0,
    this.wrongCount = 0,
    this.studyMinutes = 0,
    required this.createdAt,
  });

  factory DailyRecord.fromJson(Map<String, dynamic> json) => DailyRecord(
        date: json['date'] as String,
        newWordsCount: json['new_words_count'] as int,
        reviewWordsCount: json['review_words_count'] as int,
        correctCount: json['correct_count'] as int,
        wrongCount: json['wrong_count'] as int,
        studyMinutes: json['study_minutes'] as int,
        createdAt: json['created_at'] as int,
      );

  Map<String, dynamic> toJson() => {
        'date': date,
        'new_words_count': newWordsCount,
        'review_words_count': reviewWordsCount,
        'correct_count': correctCount,
        'wrong_count': wrongCount,
        'study_minutes': studyMinutes,
        'created_at': createdAt,
      };
}
```

---

## 五、关键SQL查询示例

### 1. 获取单词的主例句

```sql
SELECT s.* 
FROM sentences s
INNER JOIN word_sentence_map wsm ON s.id = wsm.sentence_id
WHERE wsm.word_id = ? AND wsm.is_primary = 1
LIMIT 1;
```

---

### 2. 获取需要复习的单词

```sql
SELECT * 
FROM word_progress
WHERE next_review_date <= ?
ORDER BY next_review_date ASC;
```

---

### 3. 获取已掌握的单词数量

```sql
SELECT COUNT(*) 
FROM word_progress
WHERE mastery_level >= 80;
```

---

### 4. 按年级和学期查询单词

```sql
SELECT * 
FROM words
WHERE grade = ? AND semester = ?
ORDER BY unit, id;
```

---

### 5. 搜索单词

```sql
SELECT * 
FROM words
WHERE text LIKE ? OR meaning LIKE ?
LIMIT 50;
```

---

### 6. 获取本周学习记录

```sql
SELECT * 
FROM daily_records
WHERE date >= ? AND date <= ?
ORDER BY date ASC;
```

---

## 六、数据初始化说明

### 文件放置位置

```
assets/
└── data/
    ├── words.json
    ├── sentences.json
    └── word_sentence_map.json
```

### pubspec.yaml 配置

```yaml
flutter:
  assets:
    - assets/data/words.json
    - assets/data/sentences.json
    - assets/data/word_sentence_map.json
```

---

## 七、数据同步策略

### 本地数据（SQLite）
- **存储内容：** 所有静态数据（单词、例句、关联）+ 用户动态数据（进度、统计）
- **作用：** 离线使用，快速查询
- **更新方式：** App更新时更新静态数据

### 云端数据（Supabase）
- **存储内容：** 仅用户动态数据（进度、统计、记录）
- **作用：** 跨设备同步，数据备份
- **同步策略：** 24小时手动同步一次

---

## 八、注意事项

### 1. 时间戳统一使用毫秒

```dart
// 获取当前时间戳（毫秒）
final now = DateTime.now().millisecondsSinceEpoch;

// 转换为DateTime
final dateTime = DateTime.fromMillisecondsSinceEpoch(timestamp);
```

---

### 2. 布尔值存储

SQLite没有布尔类型，使用INTEGER：
- `1` 表示 `true`
- `0` 表示 `false`

---

### 3. 外键约束

确保在数据库初始化时启用外键约束：

```dart
await db.execute('PRAGMA foreign_keys = ON');
```

---

### 4. 索引优化

所有频繁查询的字段都应该建立索引，特别是：
- `word_id`
- `next_review_date`
- `grade`, `semester`
- `date`

---

## 九、完整建表SQL脚本

```sql
-- 启用外键约束
PRAGMA foreign_keys = ON;

-- 1. 单词表
CREATE TABLE words (
    id TEXT PRIMARY KEY NOT NULL,
    text TEXT NOT NULL,
    meaning TEXT NOT NULL,
    phonetic TEXT NOT NULL,
    grade INTEGER NOT NULL,
    semester INTEGER NOT NULL,
    unit TEXT NOT NULL,
    difficulty INTEGER NOT NULL,
    category TEXT NOT NULL
);

CREATE INDEX idx_words_grade_semester ON words(grade, semester);
CREATE INDEX idx_words_unit ON words(unit);
CREATE INDEX idx_words_category ON words(category);
CREATE INDEX idx_words_text ON words(text);

-- 2. 例句表
CREATE TABLE sentences (
    id TEXT PRIMARY KEY NOT NULL,
    text TEXT NOT NULL,
    translation TEXT NOT NULL,
    category TEXT NOT NULL,
    difficulty INTEGER NOT NULL
);

CREATE INDEX idx_sentences_category ON sentences(category);

-- 3. 单词例句关联表
CREATE TABLE word_sentence_map (
    word_id TEXT NOT NULL,
    sentence_id TEXT NOT NULL,
    is_primary INTEGER NOT NULL DEFAULT 1,
    word_position INTEGER NOT NULL,
    PRIMARY KEY (word_id, sentence_id),
    FOREIGN KEY (word_id) REFERENCES words(id) ON DELETE CASCADE,
    FOREIGN KEY (sentence_id) REFERENCES sentences(id) ON DELETE CASCADE
);

CREATE INDEX idx_wsm_word ON word_sentence_map(word_id);
CREATE INDEX idx_wsm_sentence ON word_sentence_map(sentence_id);
CREATE INDEX idx_wsm_primary ON word_sentence_map(word_id, is_primary);

-- 4. 学习进度表
CREATE TABLE word_progress (
    id TEXT PRIMARY KEY NOT NULL,
    word_id TEXT NOT NULL,
    easiness_factor REAL NOT NULL DEFAULT 2.5,
    interval INTEGER NOT NULL DEFAULT 1,
    repetition INTEGER NOT NULL DEFAULT 0,
    next_review_date INTEGER NOT NULL DEFAULT 0,
    last_review_date INTEGER NOT NULL DEFAULT 0,
    review_count INTEGER NOT NULL DEFAULT 0,
    correct_count INTEGER NOT NULL DEFAULT 0,
    wrong_count INTEGER NOT NULL DEFAULT 0,
    mastery_level INTEGER NOT NULL DEFAULT 0,
    select_mode_count INTEGER NOT NULL DEFAULT 0,
    spell_mode_count INTEGER NOT NULL DEFAULT 0,
    speak_mode_count INTEGER NOT NULL DEFAULT 0,
    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL,
    FOREIGN KEY (word_id) REFERENCES words(id) ON DELETE CASCADE
);

CREATE INDEX idx_progress_word ON word_progress(word_id);
CREATE INDEX idx_progress_review_date ON word_progress(next_review_date);
CREATE INDEX idx_progress_mastery ON word_progress(mastery_level);

-- 5. 用户统计表
CREATE TABLE user_stats (
    id INTEGER PRIMARY KEY NOT NULL DEFAULT 1,
    nickname TEXT NOT NULL DEFAULT '学习者',
    current_grade INTEGER NOT NULL DEFAULT 3,
    current_semester INTEGER NOT NULL DEFAULT 1,
    total_words_learned INTEGER NOT NULL DEFAULT 0,
    total_words_mastered INTEGER NOT NULL DEFAULT 0,
    total_reviews INTEGER NOT NULL DEFAULT 0,
    total_correct INTEGER NOT NULL DEFAULT 0,
    total_wrong INTEGER NOT NULL DEFAULT 0,
    continuous_days INTEGER NOT NULL DEFAULT 0,
    total_study_days INTEGER NOT NULL DEFAULT 0,
    last_study_date TEXT NOT NULL DEFAULT '',
    total_study_minutes INTEGER NOT NULL DEFAULT 0,
    updated_at INTEGER NOT NULL
);

-- 6. 每日学习记录表
CREATE TABLE daily_records (
    date TEXT PRIMARY KEY NOT NULL,
    new_words_count INTEGER NOT NULL DEFAULT 0,
    review_words_count INTEGER NOT NULL DEFAULT 0,
    correct_count INTEGER NOT NULL DEFAULT 0,
    wrong_count INTEGER NOT NULL DEFAULT 0,
    study_minutes INTEGER NOT NULL DEFAULT 0,
    created_at INTEGER NOT NULL
);

CREATE INDEX idx_daily_records_date ON daily_records(date);
```
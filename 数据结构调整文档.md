# ä¸€ã€ç›®æ ‡ä¸è¾¹ç•Œ

æœ¬é˜¶æ®µç›®æ ‡ï¼š

* **ä¸æ¥å…¥ Supabase**
* **ä¸åšç™»å½• / æ³¨å†Œ**
* **ä¸åšå¯¼å…¥å¯¼å‡º**
* MVP å·²å®Œæˆï¼Œä»…è°ƒæ•´æ•°æ®å±‚ï¼Œä¿è¯æœªæ¥å¯æ— ç—›æ¥å…¥äº‘åŒæ­¥

æ ¸å¿ƒåŸåˆ™ï¼š

> **ç°åœ¨æ˜¯æœ¬åœ°åº”ç”¨ï¼Œä½†æ•°æ®ç»“æ„å¿…é¡»åƒâ€œäº‘åº”ç”¨â€**

---

# äºŒã€æ ¸å¿ƒè®¾è®¡æ€æƒ³ï¼ˆéå¸¸é‡è¦ï¼‰

## 1. æœ¬åœ° â‰  ä¸´æ—¶

ä½ ç°åœ¨çš„æœ¬åœ°æ•°æ®å¹¶ä¸æ˜¯â€œä»¥åä¼šè¢«ä¸¢å¼ƒâ€çš„ï¼Œè€Œæ˜¯ï¼š

* æœªæ¥ä¼šè¢«æ•´ä½“ä¸Šä¼ åˆ°äº‘ç«¯
* æˆä¸ºç”¨æˆ·è´¦å·çš„åˆå§‹æ•°æ®

æ‰€ä»¥ï¼š

* âŒ ä¸å…è®¸ä¾èµ–éšå¼çŠ¶æ€
* âŒ ä¸å…è®¸æ•£è½åœ¨å¤šä¸ªè¡¨ / å¤šä¸ª key
* âœ… å¿…é¡»æœ‰ç»Ÿä¸€çš„æ•°æ®æ ¹

---

# ä¸‰ã€ä½ éœ€è¦çš„ã€Œæœ€å°å…¼å®¹æ•°æ®æ¨¡å‹ã€

> **ä¸è¦æ±‚ä½ æ¨ç¿»ç°æœ‰è¡¨ï¼Œåªéœ€è¦â€œåŒ…ä¸€å±‚â€**

## 1. æœ¬åœ°æ•°æ®æ€»å…¥å£ï¼ˆRoot Objectï¼‰

æ— è®ºä½ ç°åœ¨æœ‰å¤šå°‘è¡¨ï¼Œæœ€ç»ˆéƒ½è¦èƒ½è¢«æ˜ å°„ä¸ºï¼š

```json
LocalRoot {
  meta: MetaInfo,
  payload: UserPayload
}
```

---

## 2. MetaInfoï¼ˆç°åœ¨å°±è¦åŠ ï¼‰

```json
MetaInfo {
  local_user_id: string,
  account_id: string | null,
  device_id: string,
  schema_version: number,
  last_modified_at: number
}
```

### å­—æ®µè¯´æ˜ï¼ˆé‡ç‚¹ï¼‰

* `local_user_id`

  * æœ¬åœ°ç”Ÿæˆ UUID
  * **å³ä½¿ä»¥åæœ‰è´¦å·ï¼Œä¹Ÿä¸åˆ é™¤**

* `account_id`

  * å½“å‰é˜¶æ®µæ°¸è¿œæ˜¯ `null`
  * æœªæ¥ç™»å½•åå†™å…¥ Supabase user id

* `device_id`

  * å®‰è£…ç”Ÿæˆ
  * ç”¨äºæœªæ¥å†²çªåˆ¤æ–­

* `schema_version`

  * ç°åœ¨å°±ä» `1` å¼€å§‹
  * æœªæ¥è¿ç§»é å®ƒæ•‘å‘½

---

## 3. UserPayloadï¼ˆä½ çœŸæ­£å…³å¿ƒçš„æ•°æ®ï¼‰

```json
UserPayload {
  vocab_progress: Map<word_id, Progress>,
  review_records: ReviewStats,
  settings: UserSettings,
  feature_flags: FeatureFlags
}
```

âš ï¸ è§„åˆ™ï¼š

> **ä¸šåŠ¡ä»£ç åªèƒ½è¯»å†™ payload**

---

# å››ã€å¦‚ä½•â€œæœ€å°ä»£ä»·â€é€‚é…ä½ ç°åœ¨çš„æ•°æ®åº“

ä½ ç°åœ¨å¯èƒ½æ˜¯ï¼š

* SQLite å¤šè¡¨
* Hive / SharedPreferences
* ObjectBox / Isar

### ä¸éœ€è¦ä½ å…¨åˆ 

ä½ åªéœ€è¦åšåˆ°ä¸€ä»¶äº‹ï¼š

> **ä»»ä½•æ—¶å€™ï¼Œéƒ½èƒ½æŠŠå½“å‰æ•°æ®å®Œæ•´åœ°åºåˆ—åŒ–æˆä¸€ä¸ª UserPayload**

---

## æ¨èè°ƒæ•´æ–¹å¼ï¼ˆé€šç”¨ï¼‰

### æ–¹æ¡ˆ Aï¼šåŠ ä¸€å±‚èšåˆå±‚ï¼ˆæ¨èï¼‰

```text
UI / ä¸šåŠ¡é€»è¾‘
   â†“
DataRepositoryï¼ˆæ–°å¢ï¼‰
   â†“
ç°æœ‰æ•°æ®åº“
```

`DataRepository` è´Ÿè´£ï¼š

* è¯»å„ä¸ªè¡¨
* æ‹¼æˆ `UserPayload`
* å†™å›æ—¶å†æ‹†åˆ†

ğŸ‘‰ æœªæ¥äº‘åŒæ­¥åªå’Œ `DataRepository` æ‰“äº¤é“

---

# äº”ã€å­—æ®µçº§è°ƒæ•´å»ºè®®ï¼ˆéå¸¸å…³é”®ï¼‰

## 1. æ‰€æœ‰ä¸šåŠ¡è¡¨å¿…é¡»æœ‰ï¼š

* `last_updated_at`
* å•è°ƒé€’å¢ï¼ˆæ¯«ç§’æ—¶é—´æˆ³ï¼‰

ä¾‹ï¼š

```sql
ALTER TABLE vocab_progress ADD COLUMN last_updated_at INTEGER;
```

---

## 2. ç¦æ­¢ä½¿ç”¨ã€Œéšå¼æ¨å¯¼çŠ¶æ€ã€

âŒ é”™è¯¯ç¤ºä¾‹ï¼š

* ç”¨â€œæ˜¯å¦å­˜åœ¨è®°å½•â€åˆ¤æ–­æ˜¯å¦å­¦è¿‡
* ç”¨æ•°ç»„é•¿åº¦åˆ¤æ–­é˜¶æ®µ

âœ… æ­£ç¡®ç¤ºä¾‹ï¼š

```json
{
  status: "learning",
  mastery: 0.6,
  last_reviewed_at: 1700000000
}
```

æœªæ¥äº‘ç«¯åªä¿¡å­—æ®µï¼Œä¸ä¿¡é€»è¾‘æ¨å¯¼ã€‚

---

# å…­ã€ä¸ºæœªæ¥ Supabase åŒæ­¥é¢„ç•™çš„åŒæ­¥æ¨¡å‹

## 1. æœªæ¥äº‘ç«¯åªå­˜ä¸€ä»½ï¼š

```json
cloud_user_data {
  account_id,
  payload,
  updated_at
}
```

ä½ ç°åœ¨åªéœ€è¦ä¿è¯ï¼š

* payload èƒ½æ•´ä½“è¦†ç›–æœ¬åœ°çŠ¶æ€

---

## 2. å†²çªè§£å†³çš„é¢„æœŸç­–ç•¥ï¼ˆå…ˆè®¾è®¡ï¼Œä¸å®ç°ï¼‰

ä¼˜å…ˆçº§é¡ºåºï¼š

1. åŒä¸€ account_id
2. æ¯”è¾ƒ `payload.last_modified_at`
3. æ–°çš„è¦†ç›–æ—§çš„

âš ï¸ ä½ ç°åœ¨ä¸ç”¨å†™ä»£ç ï¼Œä½†å­—æ®µå¿…é¡»å­˜åœ¨ã€‚

---

# ä¸ƒã€MVP é˜¶æ®µä½ **å¯ä»¥å®Œå…¨å¿½ç•¥**çš„ä¸œè¥¿

æ˜ç¡®å‘Šè¯‰ä½ å“ªäº›å¯ä»¥ä¸åšï¼š

* âŒ å¤šè®¾å¤‡åŒæ­¥
* âŒ å®æ—¶åŒæ­¥
* âŒ å†²çªåˆå¹¶ç®—æ³•
* âŒ ç”¨æˆ·åˆ‡æ¢

è¿™äº›éƒ½å±äº **Phase 2**ã€‚

---

# å…«ã€ä½ ç°åœ¨éœ€è¦åšçš„æ£€æŸ¥æ¸…å•ï¼ˆç…§ç€å‹¾ï¼‰

* [ ] æœ¬åœ°æ˜¯å¦æœ‰å”¯ä¸€ local_user_id
* [ ] æ˜¯å¦èƒ½å¯¼å‡ºå®Œæ•´ UserPayloadï¼ˆå†…éƒ¨ç”¨ï¼‰
* [ ] æ‰€æœ‰æ ¸å¿ƒæ•°æ®æ˜¯å¦æœ‰ last_updated_at
* [ ] ä¸šåŠ¡é€»è¾‘æ˜¯å¦åªä¾èµ– payload
* [ ] schema_version æ˜¯å¦å­˜åœ¨

åªè¦è¿™ 5 æ¡æ»¡è¶³ï¼Œ**æœªæ¥æ¥ Supabase 80% çš„å‘ä½ å·²ç»é¿å¼€äº†**ã€‚

---

# ä¹ã€å…³é”®æé†’ï¼ˆç»éªŒä¹‹è°ˆï¼‰

> **çœŸæ­£è®©äººé‡æ„å´©æºƒçš„ï¼Œä¸æ˜¯æ²¡äº‘ç«¯ï¼Œè€Œæ˜¯ï¼š**
>
> * è¡¨ç»“æ„ç»‘æ­»ä¸šåŠ¡é€»è¾‘
> * çŠ¶æ€é ä»£ç æ¨å¯¼

ä½ ç°åœ¨åªæ˜¯åœ¨ MVP ååŠ ä¸€å±‚â€œæ•°æ®éª¨æ¶â€ï¼Œ
ä¸æ˜¯è¿”å·¥ã€‚

---

# åã€ä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ç»§ç»­å¸®ä½ çš„äº‹

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥ç»§ç»­ï¼š
1ï¸âƒ£ æŒ‰ä½ **å½“å‰å®é™…è¡¨ç»“æ„**ç»™ä½ å¯¹ç…§è°ƒæ•´å»ºè®®
2ï¸âƒ£ ç›´æ¥ç»™ä½ ä¸€ä»½ **Supabase è¡¨ç»“æ„ + åŒæ­¥æµç¨‹å›¾**ï¼ˆç­‰ä½ å‡†å¤‡æ¥æ—¶ï¼‰
3ï¸âƒ£ å¸®ä½ æ£€æŸ¥æŸä¸ªå…·ä½“è¡¨æ˜¯ä¸æ˜¯â€œæœªæ¥å®‰å…¨â€

æˆ‘çœ‹å®Œä½ çš„æ•°æ®åº“è®¾è®¡äº†ï¼Œä½ ç°åœ¨çš„ç»“æ„æ€»ä½“ä¸Šå¾ˆå®Œæ•´ï¼Œ**åŠŸèƒ½ä¸Šå·²ç»èƒ½æ”¯æ’‘ MVP ä½¿ç”¨**ã€‚
æˆ‘å¸®ä½ åˆ†æä¸€ä¸‹å“ªäº›åœ°æ–¹éœ€è¦è°ƒæ•´æˆ–å¢åŠ å­—æ®µï¼Œä»¥ä¾¿**æœªæ¥æ— ç—›æ¥å…¥ Supabase äº‘åŒæ­¥å’Œè´¦å·ç™»å½•**ã€‚

---

# ä¸€ã€æ ¸å¿ƒé—®é¢˜åˆ†æ

ä½ çš„è¡¨å¯ä»¥åˆ†ä¸ºä¸‰ç±»ï¼š

1. **é™æ€æ•°æ®ï¼ˆè¯æ±‡è¡¨ã€ä¾‹å¥ã€æ˜ å°„è¡¨ï¼‰**

   * `words` / `sentences` / `word_sentence_map`
   * è¿™éƒ¨åˆ†å±äºæ•™ææˆ–é™æ€èµ„æºï¼Œ**ä¸ç”¨åŒæ­¥ç”¨æˆ·æ•°æ®**ï¼Œåªè¯»å³å¯ã€‚

2. **ç”¨æˆ·è¿›åº¦æ•°æ®ï¼ˆå­¦ä¹ çŠ¶æ€ã€å¤ä¹ è®°å½•ï¼‰**

   * `word_progress`
   * **å…³é”®è¡¨**ï¼Œå¿…é¡»ä¿è¯äº‘åŒæ­¥å…¼å®¹ã€‚
   * å½“å‰æœ‰ `created_at` å’Œ `updated_at`ï¼Œå¾ˆå¥½ï¼Œä½†ç¼ºå°‘ `account_id` å’Œ `device_id`ã€‚

3. **ç”¨æˆ·ç»Ÿè®¡ / å†å²æ•°æ®**

   * `user_stats` / `daily_records`
   * è¿™ç±»è¡¨åŒæ ·å±äºâ€œè´¦å·æ•°æ®â€ï¼Œ**å¿…é¡»ä¸ºæœªæ¥åŒæ­¥ä¿ç•™å­—æ®µ**ã€‚

---

# äºŒã€å…·ä½“è°ƒæ•´å»ºè®®

## 1. å…¨å±€å…ƒä¿¡æ¯ï¼ˆMetaInfoï¼‰

å»ºè®®åœ¨æœ¬åœ°æ•°æ®åº“å¢åŠ ä¸€å¼ è¡¨ `meta_info` æˆ–åœ¨ç°æœ‰è¡¨åŠ å­—æ®µï¼š

| å­—æ®µ                | ç±»å‹      | è¯´æ˜                     |
| ----------------- | ------- | ---------------------- |
| `account_id`      | TEXT    | ç™»å½•åå†™å…¥ç”¨æˆ·è´¦å· IDï¼Œæœªç™»å½•ä¸º null |
| `device_id`       | TEXT    | å®‰è£…ç”Ÿæˆ UUIDï¼Œç”¨äºåŒºåˆ†è®¾å¤‡       |
| `schema_version`  | INTEGER | æ•°æ®ç»“æ„ç‰ˆæœ¬ï¼Œæ–¹ä¾¿ä»¥åè¿ç§»          |
| `last_updated_at` | INTEGER | æ•´ä½“æ•°æ®æœ€åæ›´æ–°æ—¶é—´ï¼Œæ¯«ç§’          |

> è¿™å¼ è¡¨å¯ä»¥åªå­˜ä¸€æ¡è®°å½•ï¼Œæ‰€æœ‰åŒæ­¥éƒ½ä¾èµ–å®ƒã€‚

---

## 2. `word_progress` è°ƒæ•´

å½“å‰å­—æ®µå¾ˆå¥½ï¼Œä½†å»ºè®®ï¼š

| å­—æ®µ           | ä¿®æ”¹/æ–°å¢ | è¯´æ˜                         |
| ------------ | ----- | -------------------------- |
| `account_id` | æ–°å¢    | å¯¹åº” Supabase ç”¨æˆ· IDï¼Œæ¸¸å®¢ä¸º null |
| `device_id`  | æ–°å¢    | åŒºåˆ†è®¾å¤‡ï¼Œé˜²æ­¢å¤šè®¾å¤‡å†²çª               |
| `updated_at` | ä¿ç•™    | æœªæ¥ç”¨æ¥åšâ€œæ–°æ—§åˆ¤æ–­â€                |

* **åŸå› **ï¼šæœªæ¥åŒæ­¥æ—¶ï¼Œå¿…é¡»çŸ¥é“æŸæ¡è®°å½•å±äºå“ªä¸ªç”¨æˆ·å’Œå“ªå°è®¾å¤‡ã€‚

---

## 3. `user_stats` / `daily_records` è°ƒæ•´

åŒç†ï¼Œå¢åŠ  `account_id` / `device_id`ï¼Œæ–¹ä¾¿åŒæ­¥ã€‚

* `last_updated_at` å¯ä»£æ›¿ç°æœ‰ `updated_at` å­—æ®µï¼Œç»Ÿä¸€å‘½åã€‚
* å¦‚æœæœªæ¥å¸Œæœ›ç»Ÿè®¡å¤šç«¯ç´¯ç§¯ï¼Œå»ºè®®è®°å½• **åŸå§‹ timestamp**ã€‚

---

## 4. èšåˆå±‚ï¼ˆDataRepositoryï¼‰

å»ºè®®åœ¨ Flutter ä¸­åŠ ä¸€å±‚ï¼š

```text
UI / ä¸šåŠ¡é€»è¾‘
   â†“
DataRepository ï¼ˆè´Ÿè´£ç»„è£… UserPayloadï¼‰
   â†“
SQLite è¡¨
```

* DataRepository è´Ÿè´£æŠŠæ‰€æœ‰è¡¨åºåˆ—åŒ–æˆä¸€ä¸ª **UserPayload** JSONã€‚
* æœªæ¥åªéœ€è¦æŠŠ JSON ä¸Šä¼ åˆ° Supabaseã€‚
* è¿™æ ·å¯ä»¥**ä¸åŠ¨ç°æœ‰ä¸šåŠ¡é€»è¾‘**ã€‚

---

## 5. æ•°æ®å­—æ®µä¸€è‡´æ€§

* **æ—¶é—´æˆ³å­—æ®µ**ï¼šå…¨ç”¨æ¯«ç§’æ•´æ•°ï¼Œç»Ÿä¸€æ¯”è¾ƒï¼Œé¿å…å­—ç¬¦ä¸²/æ—¥æœŸæ··ä¹±ã€‚
* **çŠ¶æ€å­—æ®µ**ï¼šæ¯”å¦‚ `mastery_level` / `interval` / `repetition` éƒ½åº”è¯¥æ˜ç¡®ï¼Œä¸è¦ä¾èµ–æ•°ç»„é•¿åº¦æˆ–è®¡ç®—æ¨å¯¼ã€‚

> è¿™æ˜¯äº‘ç«¯åŒæ­¥æœ€å®¹æ˜“å‡ºé—®é¢˜çš„åœ°æ–¹ã€‚

---

# ä¸‰ã€è¿ç§»ç­–ç•¥å»ºè®®

* **ç°é˜¶æ®µ**ï¼šä¸æ¥ Supabaseï¼Œæ— éœ€ä¿®æ”¹ UI å’Œé€»è¾‘ï¼ŒåªåŠ å­—æ®µæˆ–è¡¨å³å¯ã€‚

* **æœªæ¥**ï¼š

  1. ç”¨æˆ·ç¬¬ä¸€æ¬¡ç™»å½• â†’ ç»™æœ¬åœ°æ•°æ®æ‰“ä¸Š `account_id`ã€‚
  2. äº‘ç«¯æ•°æ®æ‹‰å– â†’ é€šè¿‡ `updated_at` å†³å®šè¦†ç›–è§„åˆ™ã€‚
  3. DataRepository å®Œæ•´åºåˆ—åŒ– â†’ ä¸Šä¼ äº‘ç«¯ã€‚

* **æ¸¸å®¢æ•°æ®**ä¿æŒæœ¬åœ°ä¸ä¸Šä¼ ï¼Œé¿å…å†²çªã€‚

---

# å››ã€æ€»ç»“

| è¡¨                                           | ç°çŠ¶                             | å»ºè®®è°ƒæ•´                                                        |
| ------------------------------------------- | ------------------------------ | ----------------------------------------------------------- |
| `words` / `sentences` / `word_sentence_map` | é™æ€ï¼Œä¸ç”¨åŒæ­¥                        | ä¿ç•™ç°çŠ¶å³å¯                                                      |
| `word_progress`                             | å·²æœ‰ `created_at` / `updated_at` | æ–°å¢ `account_id` / `device_id`ï¼Œä¿æŒ `updated_at`               |
| `user_stats` / `daily_records`              | æœ‰ç»Ÿè®¡å­—æ®µ                          | æ–°å¢ `account_id` / `device_id` / `last_updated_at`           |
| å…¨å±€                                          | æ—                               | æ–°å¢ `meta_info` ä¿å­˜ `account_id`ã€`device_id`ã€`schema_version` |

> è¿™æ ·è°ƒæ•´åï¼Œä½ çš„ MVP **æœ¬åœ°ä½¿ç”¨ä¸å—å½±å“**ï¼Œæœªæ¥æ¥å…¥ Supabase æˆ–è´¦å·ç³»ç»Ÿæ—¶å‡ ä¹é›¶æˆæœ¬ã€‚


